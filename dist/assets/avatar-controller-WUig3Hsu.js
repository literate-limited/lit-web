var l=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var c=l((p,o)=>{class h{constructor(t,e={}){this.container=t,this.options={avatarScale:1.8,backgroundColor:988970,enableLighting:!0,enableControls:!0,...e},this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.avatar=null,this.animator=null,this.bones={},this.kalidokit=window.Kalidokit,this.isInitialized=!1,this.animationId=null,this.init()}init(){try{this.setupScene(),this.setupCamera(),this.setupRenderer(),this.setupLighting(),this.setupControls(),this.startRenderLoop(),this.isInitialized=!0,console.log("AvatarController initialized successfully")}catch(t){throw console.error("Failed to initialize AvatarController:",t),t}}setupScene(){this.scene=new THREE.Scene,this.scene.background=new THREE.Color(this.options.backgroundColor)}setupCamera(){const t=this.container.clientWidth,e=this.container.clientHeight,n=t/e;this.camera=new THREE.PerspectiveCamera(45,n,.1,1e3),this.camera.position.set(0,1.5,5),this.camera.lookAt(0,1,0),window.addEventListener("resize",()=>this.onWindowResize())}setupRenderer(){this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1,powerPreference:"high-performance"}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFShadowShadowMap,this.renderer.outputEncoding=THREE.sRGBEncoding,this.container.appendChild(this.renderer.domElement)}setupLighting(){if(!this.options.enableLighting)return;const t=new THREE.AmbientLight(16777215,.6);this.scene.add(t);const e=new THREE.DirectionalLight(16777215,.8);e.position.set(5,10,7.5),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10,this.scene.add(e);const n=new THREE.PlaneGeometry(20,20),a=new THREE.ShadowMaterial({opacity:.3}),i=new THREE.Mesh(n,a);i.receiveShadow=!0,i.rotation.x=-Math.PI/2,i.position.y=-.1,this.scene.add(i)}setupControls(){if(!(!this.options.enableControls||!window.THREE.OrbitControls))try{this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.target.set(0,1.2,0),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.autoRotate=!1,this.controls.autoRotateSpeed=2,this.controls.update()}catch{console.warn("OrbitControls not available, interaction disabled")}}async loadAvatar(t){return new Promise((e,n)=>{new THREE.GLTFLoader().load(t,i=>{this.avatar=i.scene,this.avatar.scale.setScalar(this.options.avatarScale),this.avatar.traverse(r=>{r instanceof THREE.Mesh&&(r.castShadow=!0,r.receiveShadow=!0)}),i.animations&&i.animations.length>0&&i.animations[0],this.scene.add(this.avatar),e(this.avatar)},i=>{const r=Math.round(i.loaded/i.total*100);console.log(`Avatar loading: ${r}%`)},i=>{console.error("Error loading avatar:",i),n(i)})})}async loadPoseData(t){try{const e=await fetch(`/api/reference_poses/${t}`);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const n=await e.json();if(!n.success)throw new Error(n.error||"Failed to load pose data");return this.animator||(this.animator=new PoseAnimator(this.avatar,n.fps||30),this.animator.onFrameUpdate=a=>{this.updateAvatarFromFrame(a)}),this.animator.loadFrames(n.frames),this.animator.play(),console.log(`Loaded ${n.total_frames} frames for sign: ${n.sign_word}`),!0}catch(e){return console.error("Error loading pose data:",e),!1}}updateAvatarFromFrame(t){if(!(!t||!t.landmarks||!this.kalidokit))try{const e=this.kalidokit.Pose.solve(t.landmarks,{runtime:"mediapipe",video:null,smoothBones:!0});this.applyRiggedPose(e)}catch{}}applyRiggedPose(t){if(!this.avatar)return;const e=(a,i)=>{const r=this.findBone(this.avatar,a);r&&i&&(r.rotation.order="YXZ",r.rotation.set(i.x||0,i.y||0,i.z||0))},n=(a,i)=>{const r=this.findBone(this.avatar,a);r&&i&&r.position.set(i.x||0,i.y||0,i.z||0)};t.Hips&&(n("Hips",t.Hips.position),e("Hips",t.Hips.rotation)),t.Spine&&e("Spine",t.Spine.rotation),t.Chest&&e("Chest",t.Chest.rotation),t.UpperChest&&e("UpperChest",t.UpperChest.rotation),t.Neck&&e("Neck",t.Neck.rotation),t.Head&&e("Head",t.Head.rotation),["Left","Right"].forEach(a=>{t[`${a}Shoulder`]&&e(`${a}Shoulder`,t[`${a}Shoulder`].rotation),t[`${a}UpperArm`]&&e(`${a}UpperArm`,t[`${a}UpperArm`].rotation),t[`${a}LowerArm`]&&e(`${a}LowerArm`,t[`${a}LowerArm`].rotation),t[`${a}Hand`]&&e(`${a}Hand`,t[`${a}Hand`].rotation)}),["Left","Right"].forEach(a=>{t[`${a}UpperLeg`]&&e(`${a}UpperLeg`,t[`${a}UpperLeg`].rotation),t[`${a}LowerLeg`]&&e(`${a}LowerLeg`,t[`${a}LowerLeg`].rotation),t[`${a}Foot`]&&e(`${a}Foot`,t[`${a}Foot`].rotation)})}findBone(t,e){if(this.bones[e])return this.bones[e];let n=null;return t.traverse(a=>{a.name===e&&(n=a,this.bones[e]=a)}),n}getAnimator(){return this.animator}onWindowResize(){const t=this.container.clientWidth,e=this.container.clientHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}startRenderLoop(){const t=()=>{this.animationId=requestAnimationFrame(t),this.controls&&this.controls.update(),this.renderer.render(this.scene,this.camera)};t()}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),this.animator&&(this.animator.dispose(),this.animator=null),this.scene&&this.scene.clear(),this.renderer&&this.container.contains(this.renderer.domElement)&&(this.container.removeChild(this.renderer.domElement),this.renderer.dispose()),window.removeEventListener("resize",()=>this.onWindowResize()),this.avatar=null,this.bones={}}}typeof o<"u"&&o.exports&&(o.exports=h);typeof window<"u"&&(window.AvatarController=h)});export default c();
